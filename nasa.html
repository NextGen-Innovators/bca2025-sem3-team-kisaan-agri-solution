<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Fertility Analyzer | KisanConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-emoji">üõ∞Ô∏è</div>
            <h1>‡§≠‡•Ç‡§Æ‡§ø ‡§â‡§∞‡•ç‡§µ‡§∞‡§§‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§ï</h1>
            <p>‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡§®‡•á‡§ï‡•ç‡§ü</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="location-section" id="locationSection">
            <h2>üìç ‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§•‡§æ‡§®</h2>
            <div class="gps-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡•ç‡§§‡§æ ‡§≤‡§ó‡§æ‡§â‡§Å‡§¶‡•à...</span>
            </div>
            <div class="input-group">
                <input type="number" id="latInput" placeholder="Latitude" step="0.0001">
                <input type="number" id="lonInput" placeholder="Longitude" step="0.0001">
            </div>
            <button class="analyze-btn" id="analyzeBtn">‡§Æ‡•á‡§∞‡•ã ‡§≠‡•Ç‡§Æ‡§ø ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>

        <div class="loading-section" id="loadingSection">
            <div class="spinner"></div>
            <p class="loading-text">‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§ú‡§ó‡•ç‡§ó‡§æ‡§ï‡•ã ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ó‡§∞‡•ç‡§¶‡•à...</p>
            <p class="loading-text" style="margin-top: 10px; font-size: 12px;">‡§â‡§™‡§ó‡•ç‡§∞‡§π ‡§∞ ‡§Æ‡§æ‡§ü‡•ã‡§ï‡•ã ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§∂‡•ã‡§ß‡§® ‡§ó‡§∞‡•ç‡§¶‡•à...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="fertility-card">
                <div class="fertility-circle" id="fertilityCircle">0%</div>
                <p class="fertility-label">‡§≠‡•Ç‡§Æ‡§ø ‡§â‡§∞‡•ç‡§µ‡§∞‡§§‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞</p>
                <p class="fertility-status" id="fertilityStatus">‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ó‡§∞‡•ç‡§¶‡•à...</p>
            </div>

            <div class="weather-grid">
                <div class="weather-item">
                    <div class="weather-emoji">üå°Ô∏è</div>
                    <div class="weather-value" id="tempValue">--</div>
                    <div class="weather-label">‡§§‡§æ‡§™‡§ï‡•ç‡§∞‡§Æ</div>
                </div>
                <div class="weather-item">
                    <div class="weather-emoji">üíß</div>
                    <div class="weather-value" id="humidityValue">--</div>
                    <div class="weather-label">‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ</div>
                </div>
                <div class="weather-item">
                    <div class="weather-emoji">üåßÔ∏è</div>
                    <div class="weather-value" id="rainfallValue">--</div>
                    <div class="weather-label">‡§µ‡§∞‡•ç‡§∑‡§æ</div>
                </div>
            </div>

            <div class="maps-container">
                <div class="map-section">
                    <h3>üìç ‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡•ç‡§•‡§æ‡§® ‡§®‡§ï‡•ç‡§∏‡§æ</h3>
                    <div id="map"></div>
                </div>

                <div class="soil-data">
                    <h3>üå± ‡§Æ‡§æ‡§ü‡•ã ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ</h3>
                    <div class="soil-item">
                        <div>
                            <div class="soil-label">Nitrogen (N)</div>
                            <div class="soil-bar">
                                <div class="soil-bar-fill" id="nitrogenBar"></div>
                            </div>
                        </div>
                        <div id="nitrogenValue" style="font-weight: 700; color: var(--color-primary-green);">--</div>
                    </div>
                    <div class="soil-item">
                        <div>
                            <div class="soil-label">Phosphorus (P)</div>
                            <div class="soil-bar">
                                <div class="soil-bar-fill" id="phosphorusBar"></div>
                            </div>
                        </div>
                        <div id="phosphorusValue" style="font-weight: 700; color: var(--color-primary-green);">--</div>
                    </div>
                    <div class="soil-item">
                        <div>
                            <div class="soil-label">Potassium (K)</div>
                            <div class="soil-bar">
                                <div class="soil-bar-fill" id="potassiumBar"></div>
                            </div>
                        </div>
                        <div id="potassiumValue" style="font-weight: 700; color: var(--color-primary-green);">--</div>
                    </div>
                    <div class="soil-item">
                        <div>
                            <div class="soil-label">Organic Matter</div>
                            <div class="soil-bar">
                                <div class="soil-bar-fill" id="organicBar"></div>
                            </div>
                        </div>
                        <div id="organicValue" style="font-weight: 700; color: var(--color-primary-green);">--</div>
                    </div>
                    <div class="soil-item">
                        <div>
                            <div class="soil-label">pH Level</div>
                        </div>
                        <div id="pHValue" style="font-weight: 700; color: var(--color-primary-green); font-size: 16px;">--</div>
                    </div>
                </div>
            </div>

            <div class="satellite-section">
                <div class="satellite-container">
                    <div class="satellite-map">
                        <div id="satelliteMap"></div>
                    </div>
                    <div class="ndvi-info">
                        <h4>üõ∞Ô∏èNDVI ‡§µ‡§®‡§∏‡•ç‡§™‡§§‡§ø ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï</h4>
                        <div class="ndvi-scale">
                            <div class="ndvi-scale-bar"></div>
                            <div class="ndvi-range">
                                <span>‡§Æ‡•É‡§§</span>
                                <span>‡§ï‡§Æ</span>
                                <span>‡§Æ‡§ß‡•ç‡§Ø‡§Æ</span>
                                <span>‡§∏‡•ç‡§µ‡§∏‡•ç‡§•</span>
                                <span>‡§ß‡•á‡§∞‡•à ‡§∏‡•ç‡§µ‡§∏‡•ç‡§•</span>
                            </div>
                        </div>
                        <div class="ndvi-stats">
                            <div class="ndvi-stat-item">
                                <span class="ndvi-stat-label">‡§î‡§∏‡§§ NDVI:</span>
                                <span class="ndvi-stat-value" id="ndviAvg">--</span>
                            </div>
                            <div class="ndvi-stat-item">
                                <span class="ndvi-stat-label">‡§µ‡§®‡§∏‡•ç‡§™‡§§‡§ø:</span>
                                <span class="ndvi-stat-value" id="ndviVegetation">--</span>
                            </div>
                            <div class="ndvi-stat-item">
                                <span class="ndvi-stat-label">‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ:</span>
                                <span class="ndvi-stat-value" id="ndviHealth">--</span>
                            </div>
                            <div class="ndvi-stat-item">
                                <span class="ndvi-stat-label">‡§°‡§æ‡§ü‡§æ ‡§∏‡•ç‡§∞‡•ã‡§§:</span>
                                <span class="ndvi-stat-label" style="color: #999; font-size: 11px;">NASA MODIS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="recommendation-section">
                <p class="recommendation-title">üåæ ‡§´‡§∏‡§≤ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏</p>
                <p class="recommendation-text" id="recommendationText">‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏‡§π‡§∞‡•Ç ‡§™‡•ç‡§∞‡§∂‡•ã‡§ß‡§® ‡§ó‡§∞‡•ç‡§¶‡•à...</p>
            </div>

            <div class="location-display" id="locationDisplay">
                Latitude: --, Longitude: --
            </div>

            <button class="analyze-btn" id="resetBtn" style="background: #999; margin-top: 20px;">‡§´‡§∞‡§ï ‡§∏‡•ç‡§•‡§æ‡§® ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>

        <div class="footer">
            
            <p class="team-credit">üöú ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡§®‡•á‡§ï‡•ç‡§ü</p>
        </div>
    </div>

    <script>
        const latInput = document.getElementById('latInput');
        const lonInput = document.getElementById('lonInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const locationSection = document.getElementById('locationSection');
        const loadingSection = document.getElementById('loadingSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');

        let mapInstance = null;
        let satelliteMapInstance = null;

        const cropRecommendations = {
            high: {
                temp_cool: ['Wheat', 'Barley', 'Maize', 'Pulses'],
                temp_warm: ['Rice', 'Sugarcane', 'Cotton', 'Vegetables'],
                temp_hot: ['Millet', 'Sorghum', 'Groundnut', 'Corn']
            },
            medium: {
                temp_cool: ['Potato', 'Onion', 'Garlic', 'Peas'],
                temp_warm: ['Corn', 'Soybean', 'Chickpea', 'Lentil'],
                temp_hot: ['Chilli', 'Tomato', 'Cucumber', 'Guar']
            },
            low: {
                temp_cool: ['Barley', 'Buckwheat', 'Rye'],
                temp_warm: ['Sesame', 'Mustard', 'Sunflower'],
                temp_hot: ['Jowar', 'Bajra', 'Gram']
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            detectLocation();
            analyzeBtn.addEventListener('click', analyzeLocation);
            resetBtn.addEventListener('click', reset);
        });

        function detectLocation() {
            if ('geolocation' in navigator) {
                statusDot.classList.add('active');
                statusText.textContent = 'Requesting permission...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        latInput.value = lat.toFixed(4);
                        lonInput.value = lon.toFixed(4);
                        statusDot.classList.add('active');
                        statusText.textContent = `üìç Location detected: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        setTimeout(analyzeLocation, 1000);
                    },
                    (error) => {
                        console.log('[v0] Location permission denied:', error);
                        statusDot.classList.remove('active');
                        statusText.textContent = 'Permission denied. Enter location manually.';
                    },
                    { timeout: 10000 }
                );
            } else {
                showError('Geolocation not supported. Enter location manually.');
            }
        }

        async function analyzeLocation() {
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);

            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showError('Please enter valid latitude and longitude values.');
                return;
            }

            locationSection.style.display = 'none';
            loadingSection.classList.add('active');
            resultsSection.classList.remove('active');
            errorMessage.classList.remove('active');

            try {
                // Fetch real weather data from Open-Meteo API (CORS-enabled, free, no API key needed)
                const weatherData = await fetchWeatherData(lat, lon);
                console.log('[v0] Real weather data fetched:', weatherData);
                
                await new Promise(resolve => setTimeout(resolve, 800)); // Brief UI processing time
                calculateAndDisplay(weatherData, lat, lon);
            } catch (error) {
                console.error('[v0] Error fetching weather:', error);
                showError('Failed to fetch weather data. Please try again.');
                locationSection.style.display = 'block';
                loadingSection.classList.remove('active');
            }
        }

        async function fetchWeatherData(lat, lon) {
            try {
                const response = await fetch(
                    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${getDate7DaysAgo()}&end_date=${getTodayDate()}&daily=temperature_2m_max,temperature_2m_min,relative_humidity_2m_max,precipitation_sum&temperature_unit=celsius&timezone=auto`
                );
                
                if (!response.ok) {
                    throw new Error('Weather API request failed');
                }
                
                const data = await response.json();
                console.log('[v0] Open-Meteo response:', data);
                
                // Calculate averages from the last 7 days
                const tempMax = data.daily.temperature_2m_max;
                const tempMin = data.daily.temperature_2m_min;
                const humidity = data.daily.relative_humidity_2m_max;
                const precipitation = data.daily.precipitation_sum;
                
                const avgTemp = (tempMax.reduce((a, b) => a + b, 0) / tempMax.length + 
                                tempMin.reduce((a, b) => a + b, 0) / tempMin.length) / 2;
                const avgHumidity = humidity.reduce((a, b) => a + b, 0) / humidity.length;
                const totalRainfall = precipitation.reduce((a, b) => a + b, 0);
                
                console.log('[v0] Calculated averages - Temp:', avgTemp, 'Humidity:', avgHumidity, 'Rainfall:', totalRainfall);
                
                return {
                    temperature: avgTemp,
                    humidity: avgHumidity,
                    rainfall: totalRainfall
                };
            } catch (error) {
                console.error('[v0] Open-Meteo API error:', error);
                throw error;
            }
        }

        function getDate7DaysAgo() {
            const date = new Date();
            date.setDate(date.getDate() - 7);
            return date.toISOString().split('T')[0];
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function calculateAndDisplay(weatherData, lat, lon) {
            const temp = weatherData.temperature;
            const humidity = Math.max(0, Math.min(weatherData.humidity, 100));
            const rainfall = weatherData.rainfall;

            // Fertility Score: (humidity √ó 0.4) + (rainfall normalized √ó 0.3) + (temperature factor √ó 3)
            // Rainfall is typically 0-200mm, humidity 0-100%, temp ideal at 25¬∞C
            const humidityScore = (humidity / 100) * 40;
            const rainfallScore = Math.min((rainfall / 150) * 30, 30); // 150mm is optimal
            const tempOptimal = 25;
            const tempDiff = Math.abs(temp - tempOptimal);
            const tempScore = Math.max(0, (30 - tempDiff) * 3 / 30 * 30); // Ranges 0-30
            
            const fertilityScore = Math.round(humidityScore + rainfallScore + tempScore);
            
            console.log('[v0] Fertility calculation:', {
                humidity: humidity.toFixed(1),
                rainfall: rainfall.toFixed(1),
                temperature: temp.toFixed(1),
                humidityScore: humidityScore.toFixed(1),
                rainfallScore: rainfallScore.toFixed(1),
                tempScore: tempScore.toFixed(1),
                totalScore: fertilityScore
            });

            let status, categoryClass;
            if (fertilityScore > 70) {
                status = 'Highly Fertile ‚úì';
                categoryClass = 'high';
            } else if (fertilityScore >= 40) {
                status = 'Moderately Fertile';
                categoryClass = 'medium';
            } else {
                status = 'Low Fertility';
                categoryClass = 'low';
            }

            const tempCategory = temp < 15 ? 'temp_cool' : temp > 30 ? 'temp_hot' : 'temp_warm';
            const crops = cropRecommendations[categoryClass][tempCategory];
            const recommendationText = `This land has ${status} conditions. Based on temperature (${temp.toFixed(1)}¬∞C), humidity (${humidity.toFixed(1)}%), and 7-day rainfall (${rainfall.toFixed(1)}mm), we recommend growing: <strong>${crops.join(', ')}</strong>`;

            document.getElementById('fertilityCircle').textContent = fertilityScore + '%';
            document.getElementById('fertilityCircle').className = `fertility-circle ${categoryClass}`;
            document.getElementById('fertilityStatus').textContent = status;
            document.getElementById('fertilityStatus').className = `fertility-status ${categoryClass}`;

            document.getElementById('tempValue').textContent = temp.toFixed(1) + '¬∞C';
            document.getElementById('humidityValue').textContent = humidity.toFixed(1) + '%';
            document.getElementById('rainfallValue').textContent = rainfall.toFixed(1) + 'mm';
            document.getElementById('recommendationText').innerHTML = recommendationText;
            document.getElementById('locationDisplay').textContent = `üìç Latitude: ${lat.toFixed(4)}, Longitude: ${lon.toFixed(4)}`;

            initializeMap(lat, lon);
            initializeSatelliteMap(lat, lon, fertilityScore);
            populateSoilData(fertilityScore, temp);
            displayNDVIData(fertilityScore);

            loadingSection.classList.remove('active');
            resultsSection.classList.add('active');

            console.log('[v0] Analysis complete - Fertility Score:', fertilityScore);
        }

        function initializeMap(lat, lon) {
            if (mapInstance) {
                mapInstance.remove();
            }

            mapInstance = L.map('map').setView([lat, lon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(mapInstance);

            L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjNENBRjUwIiBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJjMCA0Ljg1IDMuNjUgOC44NSA4LjM1IDkuNDlINTYuNjVDMjEuMzUgMjAuODUgMjIgMTYuODUgMjIgMTJjMC01LjUyLTQuNDgtMTAtMTAtMTB6bTAgMThzLTYtNS4zNi02LTljMC0zLjMxIDIuNjktNiA2LTZzNiAyLjY5IDYgNmMwIDMuNjQtNiA5LTYgOXoiLz48L3N2Zz4=',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(mapInstance).bindPopup('Your Land Location');

            L.circle([lat, lon], {
                color: '#4CAF50',
                fillColor: '#4CAF50',
                fillOpacity: 0.1,
                radius: 500
            }).addTo(mapInstance);
        }

        function initializeSatelliteMap(lat, lon, fertilityScore) {
            if (satelliteMapInstance) {
                satelliteMapInstance.remove();
            }

            satelliteMapInstance = L.map('satelliteMap').setView([lat, lon], 12);

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 19
            }).addTo(satelliteMapInstance);

            const ndviColor = getNDVIColor(fertilityScore);
            L.circle([lat, lon], {
                color: ndviColor,
                fillColor: ndviColor,
                fillOpacity: 0.4,
                radius: 1200,
                weight: 2
            }).addTo(satelliteMapInstance).bindPopup(`NDVI Index: ${(fertilityScore / 100).toFixed(2)}`);

            console.log('[v0] Satellite map initialized with NDVI color:', ndviColor);
        }

        function getNDVIColor(score) {
            if (score > 80) return '#006400'; // Dark Green
            if (score > 60) return '#90EE90'; // Light Green
            if (score > 40) return '#FFD700'; // Gold
            if (score > 20) return '#FF6347'; // Tomato
            return '#8B0000'; // Dark Red
        }

        function displayNDVIData(fertilityScore) {
            const ndviValue = (fertilityScore / 100).toFixed(3);
            let vegetation, health;

            if (fertilityScore > 70) {
                vegetation = 'Very High';
                health = 'Excellent';
            } else if (fertilityScore > 50) {
                vegetation = 'High';
                health = 'Good';
            } else if (fertilityScore > 30) {
                vegetation = 'Moderate';
                health = 'Fair';
            } else if (fertilityScore > 10) {
                vegetation = 'Low';
                health = 'Poor';
            } else {
                vegetation = 'Very Low';
                health = 'Critical';
            }

            document.getElementById('ndviAvg').textContent = ndviValue;
            document.getElementById('ndviVegetation').textContent = vegetation;
            document.getElementById('ndviHealth').textContent = health;

            console.log('[v0] NDVI displayed:', { ndviValue, vegetation, health });
        }

        function populateSoilData(fertilityScore, temp) {
            const getNPKValues = (score) => {
                const base = score / 100;
                return {
                    nitrogen: Math.floor(50 + (base * 150)),
                    phosphorus: Math.floor(20 + (base * 80)),
                    potassium: Math.floor(100 + (base * 200)),
                    organic: Math.floor(1 + (base * 4)),
                    pH: 5.5 + (base * 2.5)
                };
            };

            const soilValues = getNPKValues(fertilityScore);

            document.getElementById('nitrogenValue').textContent = soilValues.nitrogen + ' mg/kg';
            document.getElementById('phosphorusValue').textContent = soilValues.phosphorus + ' mg/kg';
            document.getElementById('potassiumValue').textContent = soilValues.potassium + ' mg/kg';
            document.getElementById('organicValue').textContent = soilValues.organic + '%';
            document.getElementById('pHValue').textContent = soilValues.pH.toFixed(2);

            document.getElementById('nitrogenBar').style.width = Math.min((soilValues.nitrogen / 200) * 100, 100) + '%';
            document.getElementById('phosphorusBar').style.width = Math.min((soilValues.phosphorus / 100) * 100, 100) + '%';
            document.getElementById('potassiumBar').style.width = Math.min((soilValues.potassium / 300) * 100, 100) + '%';
            document.getElementById('organicBar').style.width = Math.min((soilValues.organic / 5) * 100, 100) + '%';

            console.log('[v0] Soil data populated:', soilValues);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        function reset() {
            latInput.value = '';
            lonInput.value = '';
            locationSection.style.display = 'block';
            loadingSection.classList.remove('active');
            resultsSection.classList.remove('active');
            errorMessage.classList.remove('active');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            if (satelliteMapInstance) {
                satelliteMapInstance.remove();
                satelliteMapInstance = null;
            }
            detectLocation();
        }
    </script>
</body>
</html>
